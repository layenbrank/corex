name: Release

on:
  push:
    tags:
      - v*

permissions:
  contents: write
  packages: write
  issues: write
  pull-requests: write

env:
  CARGO_TERM_COLOR: always

jobs:
  create_release:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Update dependencies
        run: cargo update

      - name: Run tests
        run: cargo test --release

      - name: Build release binary
        run: cargo build --release --verbose

      - name: Strip binary (optional)
        run: |
          if (Test-Path "target\release\corex.exe") {
            Write-Host "Binary built successfully"
          } else {
            Write-Error "Binary not found"
            exit 1
          }

      - name: Create release package
        run: |
          mkdir release-package
          copy target\release\corex.exe release-package\

          # æ·»åŠ å…¶ä»–æ–‡ä»¶ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          if (Test-Path "README.md") { copy README.md release-package\ }
          if (Test-Path "LICENSE") { copy LICENSE release-package\ }
          if (Test-Path "CHANGELOG.md") { copy CHANGELOG.md release-package\ }

          # åˆ›å»ºåŽ‹ç¼©åŒ…
          powershell Compress-Archive -Path release-package\* -DestinationPath "corex-${{ github.ref_name }}-windows-x64.zip"

      - name: Get commit info
        id: commit_info
        run: |
          $commit_hash = git rev-parse HEAD
          $commit_short = git rev-parse --short HEAD
          $commit_message = git log -1 --pretty=format:"%s"
          $commit_author = git log -1 --pretty=format:"%an"
          $commit_date = git log -1 --pretty=format:"%ci"

          echo "hash=$commit_hash" >> $env:GITHUB_OUTPUT
          echo "short=$commit_short" >> $env:GITHUB_OUTPUT
          echo "message=$commit_message" >> $env:GITHUB_OUTPUT
          echo "author=$commit_author" >> $env:GITHUB_OUTPUT
          echo "date=$commit_date" >> $env:GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            corex-${{ github.ref_name }}-windows-x64.zip
            target/release/corex.exe
          name: Release ${{ github.ref_name }}
          body: |
            ## What's Changed in ${{ github.ref_name }}

            ### ðŸ“¦ Release Information
            - **Tag**: ${{ github.ref_name }}
            - **Commit**: `${{ steps.commit_info.outputs.short }}` 
            - **Author**: ${{ steps.commit_info.outputs.author }}
            - **Date**: ${{ steps.commit_info.outputs.date }}

            ### ðŸ’¬ Commit Message
            ```
            ${{ steps.commit_info.outputs.message }}
            ```

            ### ðŸ”§ Build Information
            - Binary built for Windows x64
            - Built with Rust stable toolchain
            - Optimized release build with LTO enabled

            ### ðŸ“‹ Full Changelog
            **Full Commit**: [`${{ steps.commit_info.outputs.short }}`](https://github.com/${{ github.repository }}/commit/${{ steps.commit_info.outputs.hash }})
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          generate_release_notes: true
        # env:
        #   GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
